machine:
  services:
    - docker

dependencies:
  override:
    - mkdir -p ~/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}
    - ln -s ${HOME}/${CIRCLE_PROJECT_REPONAME} ${HOME}/.go_project/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
    - make get-deps

compile:
  override:
    - cd server && go build -o sss-server
    - docker build --rm=false -t itslabq/sss -f dockerfile/Dockerfile .

test:
  pre:
    -|
      cat << EOS > client/sss.yml
      servers:
        - address: 127.0.0.1
          port: 13009
      EOS
  override:
    - make test
    - docker run -d --name sss-server -p 13009:13009 itslabq/sss
    - cd client && go build
    - cd client && client remote put sss.yml
    - cd client && client remote get sss.yml --output sss2.yml
    - cd client && diff sss.yml sss2.yml
    - docker kill sss-server && docker rm sss-server

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push itslabq/sss
